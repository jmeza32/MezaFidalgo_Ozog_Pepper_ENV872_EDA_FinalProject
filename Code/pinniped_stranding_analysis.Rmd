---
title: "Pinniped Analysis"
author: "Joshua Meza-Fidalgo"
date: '2022-04-02'
output:
  html_document:
    df_print: paged
---
>Set Up

```{r Setup, warning = FALSE, message = FALSE}
library(tidyverse)
library(tidyr)
library(lubridate)
library(dplyr)
library(cowplot)
library(ggplot2)
library(ggridges)
library(agricolae)
library(lubridate)
library(corrplot)
library(htmltools)
library(sf)
library(leaflet)
library(mapview)
library(RColorBrewer)
library(leafsync)
library(trend)
library(zoo)
library(Kendall)
library(tseries)
library(knitr)

getwd()

mytheme <- theme_bw() +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right")
theme_set(mytheme)
```


```{r Data Setup}
Stranding_Data <- read.csv("../Data/Processed/strandings_final.csv", stringsAsFactors = TRUE)

Pinniped_Stranding_Data <- Stranding_Data %>%
  filter(Family == "Pinnipeds") %>%
  select(Family:longitude)

Pinniped_Stranding_Data$Date <- as.Date(Pinniped_Stranding_Data$Date, format = "%Y-%m-%d")



Annual_Strandings_Totals <- read.csv("../Data/Processed/annual_strandings_totals.csv", stringsAsFactors = TRUE)

Annual_Pinniped_Strandings <- Annual_Strandings_Totals %>%
  select(Year, Pinnipeds_Total)

Monthly_Strandings_Totals <- read.csv("../Data/Processed/monthly_strandings_totals.csv", stringsAsFactors = TRUE)

Monthly_Pinniped_Strandings <- Monthly_Strandings_Totals %>%
  select(Month, Pinnipeds_Total)




Pinniped_Stranding_Totals <- Pinniped_Stranding_Data %>%
                    filter(Family == "Pinnipeds") %>%
                    group_by(Date) %>%
                    summarise(Total = n())
```


>Pinniped Data Exploration

```{r Pinniped Data Exploration}
summary(Pinniped_Stranding_Data)

ggplot(Pinniped_Stranding_Data) +
  geom_bar(aes(x = Year, fill = common_name)) +
  ylab("Count") +
  labs(title = "Total Pinniped Strandings per Year by Species") + 
  scale_fill_discrete(name = "Pinniped Species", labels = c("Atlantic Gray Seal", "Harbor Seal", "Harp Seal", "Hooded Seal", "Unidentified Pinniped"))


ggplot(Pinniped_Stranding_Data) +
  geom_bar(aes(x = Month, fill = common_name)) +
  ylab("Count") +
  labs(title = "Total Pinniped Strandings per Month by Species") + 
  scale_fill_discrete(name = "Pinniped Species", labels = c("Atlantic Gray Seal", "Harbor Seal", "Harp Seal", "Hooded Seal", "Unidentified Pinniped")) +
  scale_x_discrete(name = "Month",
                   limits = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))
```

No apparent trend based on yearly data, possible seasonal trend based on month/season.



```{r Geospatial Exploration}
Pinniped_sf <- Pinniped_Stranding_Data %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

mapview(Pinniped_sf)
```



>Pinniped Analysis


>>Statisical Analysis

Null Hypothesis 1: There is no effect of year on the total number of pinniped strandings
Alternative Hypothesis 1: There is an effect of year on the total number of pinniped strandings

Null Hypothesis 2: There is no effect of month on the total number of pinniped strandings
Alternative Hypothesis 2: There is an effect of month on the total number of pinniped strandings

```{r ANOVA Models}
Pinniped_Model <- aov(data = Annual_Pinniped_Strandings, Pinnipeds_Total ~ Year)

Pinniped_Model

summary.aov(Pinniped_Model)

Pinniped_Model2 <- aov(data = Monthly_Pinniped_Strandings, Pinnipeds_Total ~ Month)

Pinniped_Model2

summary.aov(Pinniped_Model2)
```

We reject the null hypothesis that there is no effect of year on the total number of pinniped strandings due to a p-value of 0.027.  We also reject the null hypothesis that there is no effect of month on the total number of pinniped strandings due to a p-value of 0.018.  These  effects could likely be explained by differing environmental factors each year, however our dataset did not include such data.  This could be an avenue of further research for a future project, if such environmental data is available.    



>>Geospatial Analysis

```{r}
Pinniped_sf_utm <- st_transform(Pinniped_sf,32619)
#The data points straddle UTM zones 18 and 19, zone 19 was chosen because that is where the greatest concentration of points seems to be located.

Pinniped_sf_utm$geometry


long_mean <- mean(Pinniped_Stranding_Data$longitude)
lat_mean <- mean(Pinniped_Stranding_Data$latitude)

Pinniped_Stranding_Mean_Point <- data.frame(long_mean, lat_mean)

Pinniped_Mean_sf <- Pinniped_Stranding_Mean_Point %>%
  st_as_sf(coords = c("long_mean", "lat_mean"), crs = 4326)

Pinniped_Mean_UTM <- st_transform(Pinniped_Mean_sf,32619)


Pinniped_Distance_Matrix <- st_distance(Pinniped_sf_utm, Pinniped_sf_utm, pairwise = T)

mean_distance <-  rowMeans(Pinniped_Distance_Matrix)

Pinniped_sf_utm  <-  Pinniped_sf_utm %>% 
  bind_cols(mean_distance = mean_distance)
```

```{r}
mapview(Pinniped_sf_utm, 
        zcol = "mean_distance",
        layer.name = "Distance (m) from Mean Stranding Point")
```

Knowing where the "mean" stranding location is could allow for a study of that area in order to determine why pinniped strandings are so prominent on this area and allow for the allocation of more recovery resources and personnel to that area to compensate for the higher levels of strandings. 




```{r Distance Table}
# points within 40,000m
Pinniped_40 <- Pinniped_sf_utm %>%
  filter(mean_distance < 40000) %>%
  mutate(distance_group = "< 40,000")

# points between 40,000m - 60,000m
Pinniped_40_60 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 40000 & mean_distance < 60000) %>%
  mutate(distance_group = "40,000 - 60,000")

# points between 60,000m - 80,000m
Pinniped_60_80 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 60000 & mean_distance < 80000) %>%
  mutate(distance_group = "60,000 - 80,000")

# points between 80,000m - 100,000m
Pinniped_80_100 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 80000 & mean_distance < 100000) %>%
  mutate(distance_group = "80,000 - 100,000")

# points between 100,000m - 120,000m
Pinniped_100_120 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 100000 & mean_distance < 120000) %>%
  mutate(distance_group = "100,000 - 120,000")

# points between 120,000m - 140,000m
Pinniped_120_140 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 120000 & mean_distance < 140000) %>%
  mutate(distance_group = "120,000 - 140,000")

# points between 140,000m - 160,000m
Pinniped_140_160 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 140000 & mean_distance < 160000) %>%
  mutate(distance_group = "140,000 - 160,000")

# points greater than 160,000m
Pinniped_160 <- Pinniped_sf_utm %>%
  filter(mean_distance >= 160000) %>%
  mutate(distance_group = "> 160,000")

# row bind the distance dataframes
Pinniped_sf_utm_final <- rbind(Pinniped_40, Pinniped_40_60, Pinniped_60_80, Pinniped_80_100, Pinniped_100_120, Pinniped_120_140, Pinniped_140_160, Pinniped_160)

Pinniped_distances <- Pinniped_sf_utm_final %>%
  group_by(distance_group) %>%
  summarise(totals_by_distance = n()) %>%
  st_drop_geometry() %>%
  arrange(totals_by_distance)

kable(Pinniped_distances)
```


>>Temporal Analysis

Null Hypothesis: The pinniped stranding data is stationary
Alternative Hypothesis: The pinniped stranding data is not stationary

```{r Monthly Time Series}
f_month <- month(first(Pinniped_Stranding_Totals$Date))
f_year <- year(first(Pinniped_Stranding_Totals$Date))


Pinniped_ts_monthly <- ts(Pinniped_Stranding_Totals$Total, 
                  start = c(f_year, f_month), 
                  frequency = 12)
 
Pinniped_ts_monthly_decomp <- stl(Pinniped_ts_monthly, s.window = "periodic")
plot(Pinniped_ts_monthly_decomp)

Pinniped_ts_monthly_trend <- Kendall::SeasonalMannKendall(Pinniped_ts_monthly)

summary(Pinniped_ts_monthly_trend)

```




```{r Yearly Time Series}
Pinniped_ts_yearly <- ts(Pinniped_Stranding_Totals, start = c(1990,1), frequency = 1)

Pinniped_ts_yearly_trend <- Kendall::SeasonalMannKendall(Pinniped_ts_yearly)

summary(Pinniped_ts_yearly_trend)
```





---
title: "Marine Stranding Analysis -- Britney's File #2 :)"
author: "Britney Pepper"
date: "4/2/2022"
output: html_document
  html_document:
    df_print: paged
---

#Setup
```{r Setup, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Working Directory
getwd()

#Load packages
library(tidyverse)
library(tidyr)
library(lubridate)
library(dplyr)
library(cowplot)
library(ggplot2)
library(ggridges)
library(agricolae)
library(lubridate)
library(corrplot)
library(htmltools)
library(sf)
library(leaflet)
library(mapview)
library(RColorBrewer)
library(leafsync)
library(trend)
library(zoo)
library(Kendall)
library(tseries)
library(knitr)

#Set theme
mytheme <- theme_bw() +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right")
theme_set(mytheme)
```


#Load Data
```{r Data}
stranding_data <- read.csv("../Data/Processed/strandings_final.csv", stringsAsFactors = TRUE)

#Mysticetes Data
mysticete_stranding_data <- stranding_data %>%
  filter(Family == "Mysticetes") %>%
  select(Family:longitude)

#Setting the date
mysticete_stranding_data$Date <- as.Date(mysticete_stranding_data$Date, format = "%Y-%m-%d")


#Annual Strandings
annual_strandings_totals <- read.csv("../Data/Processed/annual_strandings_totals.csv", stringsAsFactors = TRUE)

annual_mysticetes_strandings <- annual_strandings_totals %>%
  select(Year, Mysticetes_Total)

#Monthly Strandings
monthly_strandings_totals <- read.csv("../Data/Processed/monthly_strandings_totals.csv", stringsAsFactors = TRUE)

monthly_mysticetes_strandings <- monthly_strandings_totals %>%
  select(Month, Mysticetes_Total)



#Mysticete Stranding Numbers
mysticete_stranding_numbers <- mysticete_stranding_data %>%
                    filter(Family == "Mysticetes") %>%
                    group_by(Date) %>%
                    summarise(Total = n())
```



#Mysticete Data Exploration
```{r Pinniped Data Exploration}
summary(mysticete_stranding_data)

#By year
ggplot(mysticete_stranding_data) +
  geom_bar(aes(x = Year, fill = common_name)) +
  ylab("Count") +
  labs(title = "Total Mysticete Strandings per Year by Species") +
  scale_fill_discrete(name = "Mysticete Species", labels = c("Baleen Whale","Blue Whale", "Unknown Cetaceans",  "Fin Whale", "Humpback Whale", "Minke Whale", "North Atlantic Right Whale"))

#By month
ggplot(mysticete_stranding_data) +
  geom_bar(aes(x = Month, fill = common_name)) +
  ylab("Count") +
  labs(title = "Total Mysticete Strandings per Month by Species") + 
  scale_fill_discrete(name = "Mysticete Species", labels = c("Baleen Whale","Blue Whale", "Unknown Cetaceans",  "Fin Whale", "Humpback Whale", "Minke Whale", "North Atlantic Right Whale")) +
  scale_x_discrete(name = "Month",
                   limits = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))
```

There appears to be an increasing trend in the number of mysticete strandings as the years progress.
There also appears to be a seasonal trend based on season, where the months of June and July have a much greater ammount of strandings than the rest of the year. 



```{r Geospatial Exploration}
mysticete_sf <- mysticete_stranding_data %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

mapview(mysticete_sf)
```



#Mysticete Analysis
##Statisical Analysis

Null Hypothesis 1: There is no effect of year on the total number of mysticete strandings
Alternative Hypothesis 1: There is an effect of year on the total number of mysticete strandings

Null Hypothesis 2: There is no effect of month on the total number of mysticete strandings
Alternative Hypothesis 2: There is an effect of month on the total number of mysticete strandings

```{r ANOVA Models}
mysticete_model <- aov(data = annual_mysticetes_strandings, Mysticetes_Total ~ Year)
mysticete_model
summary.aov(mysticete_model)

mysticete_model2 <- aov(data = monthly_mysticetes_strandings, Mysticetes_Total ~ Month)
mysticete_model2
summary.aov(mysticete_model2)
```

We reject the null hypothesis that there is no effect of year on the total number of odontocete strandings due to a p-value of 2.16e-06. We also fail to reject the null hypothesis that there is no effect of month on the total number of odontocete strandings due to a p-value of 0.424. This indicates that there is a difference in the number of odontocete strandings across the years of the study, but not across the months. This could be explained by increase boat and shipping traffic as the years progress that contribute to increased ocean noise and interference with their communication that have led them to become stranded. Seasonality may not have an effect because of the consistency of boat and ship traffic throughout each year.



#Geospatial Analysis
```{r Geospatial Analysis}
#Transform the data to UTM 19
odontocete_sf_utm <- st_transform(odontocete_sf,32619)
#The data points straddle UTM zones 18 and 19, zone 19 was chosen because that is where the greatest concentration of points seems to be located.

odontocete_sf_utm$geometry


odo_long_mean <- mean(odontocete_stranding_data$longitude)
odo_lat_mean <- mean(odontocete_stranding_data$latitude)

odontocete_stranding_mean_point <- data.frame(odo_long_mean, odo_lat_mean)

odontocete_mean_sf <- odontocete_stranding_mean_point %>%
  st_as_sf(coords = c("odo_long_mean", "odo_lat_mean"), crs = 4326)

odontocete_mean_utm <- st_transform(odontocete_mean_sf,32619)

odontocete_distance_matrix <- st_distance(odontocete_sf_utm, odontocete_sf_utm, pairwise = T)

odo_mean_distance <-  rowMeans(odontocete_distance_matrix)

odontocete_sf_utm  <-  odontocete_sf_utm %>% 
  bind_cols(odo_mean_distance = odo_mean_distance)
```

```{r Mapping the mean distance}
mapview(odontocete_sf_utm, 
        zcol = "odo_mean_distance",
        layer.name = "Distance (m) from Mean Stranding Point")
```

Knowing where the "mean" stranding location is could allow for a study of that area in order to determine why odontocete strandings are so prominent on this area and allow for the allocation of more recovery resources and personnel to that area to compensate for the higher levels of strandings. Much of the strandings occurred from Charlestown to Newport, in the Rhode Island Sound.




```{r Distance Table}
# points within 40,000m
odontocete_40 <- odontocete_sf_utm %>%
  filter(odo_mean_distance < 40000) %>%
  mutate(distance_group = "< 40,000")

# points between 40,000m - 60,000m
odontocete_40_60 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 40000 & odo_mean_distance < 60000) %>%
  mutate(distance_group = "40,000 - 60,000")

# points between 60,000m - 80,000m
odontocete_60_80 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 60000 & odo_mean_distance < 80000) %>%
  mutate(distance_group = "60,000 - 80,000")

# points between 80,000m - 100,000m
odontocete_80_100 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 80000 & odo_mean_distance < 100000) %>%
  mutate(distance_group = "80,000 - 100,000")

# points between 100,000m - 120,000m
odontocete_100_120 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 100000 & odo_mean_distance < 120000) %>%
  mutate(distance_group = "100,000 - 120,000")

# points between 120,000m - 140,000m
odontocete_120_140 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 120000 & odo_mean_distance < 140000) %>%
  mutate(distance_group = "120,000 - 140,000")

# points between 140,000m - 160,000m
odontocete_140_160 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 140000 & odo_mean_distance < 160000) %>%
  mutate(distance_group = "140,000 - 160,000")

# points greater than 160,000m
odontocete_160 <- odontocete_sf_utm %>%
  filter(odo_mean_distance >= 160000) %>%
  mutate(distance_group = "> 160,000")

# row bind the distance dataframes
odontocete_sf_utm_final <- rbind(odontocete_40, odontocete_40_60, odontocete_60_80, odontocete_80_100, odontocete_100_120, odontocete_120_140, odontocete_140_160, odontocete_160)

odontocete_distances <- odontocete_sf_utm_final %>%
  group_by(distance_group) %>%
  summarise(totals_by_distance = n()) %>%
  st_drop_geometry() %>%
  arrange(totals_by_distance)

kable(odontocete_distances)
```


#Temporal Analysis
Null Hypothesis: The odontocetes stranding data is stationary
Alternative Hypothesis: The odontocetes stranding data is not stationary

```{r Monthly Time Series}
odo_f_month <- month(first(odontocete_stranding_numbers$Date))

odontocete_ts_monthly <- ts(odontocete_stranding_numbers$Total, 
                  start = c(odo_f_year, odo_f_month), 
                  frequency = 12)
 
odontocete_ts_monthly_decomp <- stl(odontocete_ts_monthly, s.window = "periodic")
plot(odontocete_ts_monthly_decomp)

odontocete_ts_monthly_trend <- Kendall::SeasonalMannKendall(odontocete_ts_monthly)

summary(odontocete_ts_monthly_trend)

```
Because the 2-sided p-value was 0.434, we fail to reject the null hypothesis and say that odontocetes monthly stranding data is stationary.



```{r Yearly Time Series}
odo_f_year <- year(first(odontocete_stranding_numbers$Date))

odontocete_ts_yearly <- ts(odontocete_stranding_numbers, start = c(1990,1), frequency = 1)

odontocete_ts_yearly_trend <- Kendall::SeasonalMannKendall(odontocete_ts_yearly)

summary(odontocete_ts_yearly_trend)
```
Because the 2-sided p-value was less 7.53e-12, we reject the null hypothesis and say that odontocete yearly stranding data is not stationary. 

